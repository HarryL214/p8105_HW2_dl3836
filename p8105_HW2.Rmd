---
title: "P8105_hw2"
author: "Dianchen Li"
date: "2025-09-30"
output: github_document
---

```{r}
library(tidyverse)
library(janitor)
library(here)
library(readxl)
library(stringr)
library(readr)
library(lubridate)
library(knitr)
```
#Problem 1
## Tidy up pols_month.csv
```{r}
pols = 
  read_csv(here("pols-month.csv")) %>% 
  clean_names() %>% 
  separate(mon, into = c("year", "month", "day"), sep = "-", convert = TRUE) %>% 
  mutate(
    month = tolower(month.name[month]),
    president = if_else(prez_gop == 1, "gop", "dem")
  ) %>% 
  select(year, month, president,
         gov_gop, sen_gop, rep_gop,
         gov_dem, sen_dem, rep_dem) %>% 
  arrange(year, month)

```

##Tidy up snp.csv
```{r}
snp = 
  read_csv(here("snp.csv")) %>% 
  clean_names() %>% 
  separate(date, into = c("month", "day", "year"), sep = "/", convert = TRUE) %>% 
  mutate(
    year = year + 2000,
    year = if_else(year > 2015, year - 100, year),
    month = tolower(month.name[month])
  ) %>% 
  select(year, month, close) %>% 
  arrange(year, month)
```
## Tidy up unemployment.csv
```{r}
unemp = 
  read_csv(here("unemployment.csv")) %>% 
  clean_names() %>% 
  pivot_longer(
    jan:dec, 
    names_to = "month_abbr", values_to = "unemployment"
  ) %>% 
  mutate(
    month = recode(month_abbr,
      "jan" = "january", "feb" = "february", "mar" = "march",
      "apr" = "april",   "may" = "may",       "jun" = "june",
      "jul" = "july",    "aug" = "august",    "sep" = "september",
      "oct" = "october", "nov" = "november",  "dec" = "december"
    )
  ) %>% 
  select(year, month, unemployment) %>% 
  arrange(year, month)

```
##Combine each dataset
```{r}
merged_df <- 
  pols %>% 
  left_join(snp,   by = c("year", "month")) %>% 
  left_join(unemp, by = c("year", "month")) %>% 
  arrange(year, month)

```

#Problem 2
```{r}
tw_path = here( "202409 Trash Wheel Collection Data.xlsx")
```

##Specify which column we want to keep
```{r}
wanted_cols = c(
  "dumpster", "month", "year", "date",
  "weight_tons", "volume_cubic_yards",
  "plastic_bottles", "polystyrene",
  "cigarette_butts", "glass_bottles",
  "grocery_bags", "chip_bags",
  "sports_balls", "homes_powered"
)

read_clean_trash = function(sheet_name, wheel_label, skip_rows = 1) {

  raw = read_excel(
    path  = tw_path,
    sheet = sheet_name,
    skip  = skip_rows
  ) %>%
    clean_names()

  keep = intersect(wanted_cols, names(raw))

  df = raw %>%
    select(all_of(keep)) %>%
    # keep only rows with a dumpster number (drop totals/notes)
    filter(!is.na(dumpster)) %>%
    mutate(
      month = str_to_title(as.character(month)),
      date  = as.Date(date),
      year  = as.integer(year),
      wheel = wheel_label
    )
  
if (!"sports_balls" %in% names(df)) {
    df = df %>% mutate(sports_balls = NA_integer_)
  } else {
    df = df %>% mutate(sports_balls = as.integer(round(sports_balls)))
  }

  return(df)
}
```

##Then we read the three relevent variable and clean it
```{r}
mr_df   = read_clean_trash("Mr. Trash Wheel", "Mr. Trash Wheel")
prof_df = read_clean_trash("Professor Trash Wheel",  "Professor Trash Wheel")
gwyn_df = read_clean_trash("Gwynnda Trash Wheel",    "Gwynnda Trash Wheel")

trash_all = bind_rows(mr_df, prof_df, gwyn_df) %>%
  arrange(year, month, dumpster)
```
##Data for Inline R
```{r}
n_obs_trash = nrow(trash_all)
prof_total_weight = trash_all %>%
  filter(wheel == "Professor Trash Wheel") %>%
  summarise(total_weight_tons = sum(weight_tons, na.rm = TRUE)) %>%
  pull(total_weight_tons)

gwyn_jun2022_cigs = trash_all %>%
  filter(wheel == "Gwynnda Trash Wheel", year == 2022, month == "June") %>%
  summarise(total_cigs = sum(cigarette_butts, na.rm = TRUE)) %>%
  pull(total_cigs)

key_vars = intersect(wanted_cols, names(trash_all))

```


After cleaning and combinin, thedataset contains **`r n_obs_trash` observations**, and each obswervation correlates to a dumpsterand contains variables like **`r paste(key_vars, collapse = ", ")`**, that create a link to the collection time, weight of trash, volume of trash, and so on. In the available data, **Professor Trash Wheel** collected a total of **`r round(prof_total_weight, 1)` tons** of trash, and **Gwynnda Trash Wheel** collected **`r gwyn_jun2022_cigs` cigarette butts** in **June 2022**.

#Problem 3
##basic setup
```{r}
zip_zori = here("Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv")
zip_codes = here("Zip Codes.csv")
nyc_borough_order = c("Manhattan", "Brooklyn", "Queens", "Bronx", "Staten Island")
```

##Data clean up
```{r}
zori_raw = read_csv(zip_zori)

zori_long = zori_raw %>%
  mutate(zip = sprintf("%05s", as.character(RegionName))) %>%
  pivot_longer(
    cols = matches("^\\d{4}-\\d{2}-\\d{2}$"), 
    names_to = "date",
    values_to = "zori"
  ) %>%
  mutate(
    date = as.Date(date),
    year = year(date),
    month = month(date, label = TRUE, abbr = FALSE) |> as.character()
  ) %>%
  select(zip, date, year, month, zori,
         CountyName, City, StateName, State, Metro) %>%
  clean_names() %>%
  arrange(zip, date)
```
```{r}
zipmap_raw = read_csv(zip_codes) %>% clean_names()

zipmap = zipmap_raw %>%
  mutate(
    # 这里改：zipcode -> zip_code
    zip = sprintf("%05d", as.integer(zip_code)),
    borough = case_when(
      county == "Bronx"      ~ "Bronx",
      county == "Kings"      ~ "Brooklyn",
      county == "New York"   ~ "Manhattan",
      county == "Queens"     ~ "Queens",
      county == "Richmond"   ~ "Staten Island",
      TRUE ~ county
    )
  ) %>%
  select(zip, borough, neighborhood) %>%
  mutate(borough = factor(borough, levels = nyc_borough_order, ordered = TRUE)) %>%
  arrange(borough, zip)
```
#Integrate together
```{r}
zori_with_borough = zori_long %>%
  mutate(
    borough = case_when(
      county_name == "Bronx"        ~ "Bronx",
      county_name == "Kings"        ~ "Brooklyn",
      county_name == "New York"     ~ "Manhattan",
      county_name == "Queens"       ~ "Queens",
      county_name == "Richmond"     ~ "Staten Island",
      TRUE ~ NA_character_
    )
  )

neighborhood_lookup = zipmap %>%
  group_by(zip) %>%
  summarise(
    neighborhoods = paste(sort(unique(neighborhood)), collapse = "; "),
    .groups = "drop"
  )

zori_nyc = zori_with_borough %>%
  left_join(neighborhood_lookup, by = "zip") %>%
  relocate(borough, neighborhoods, .after = zip) %>%
  arrange(borough, zip, date)

```

##Inline R check
```{r}
n_obs_total = nrow(zori_nyc)
n_zip_total = dplyr::n_distinct(zori_nyc$zip)

n_hood_total =
  zori_nyc %>%
  tidyr::separate_rows(neighborhoods, sep = ";\\s*") %>%
  summarise(n = dplyr::n_distinct(neighborhoods)) %>%
  dplyr::pull(n)

n_missing_zips =
  zipmap %>%
  distinct(zip) %>%
  anti_join(zori_long %>% distinct(zip), by = "zip") %>%
  nrow()
```

I build a dataset which has **`r n_obs_total`** monthly observations.  
These cover **`r n_zip_total`** ZIP codes and **`r n_hood_total`** neighborhoods in New York City.  

When comparing zip map file with Zillow’s rental chart, I found **`r n_missing_zips`** ZIP codes present in the map but not in the Zillow.  
These missing ZIP codes are often special-purpose codes such as airports, PO Boxes, and so on.











